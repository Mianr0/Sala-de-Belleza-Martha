<script is:inline>
  class ChatWidget {
    constructor(config) {
      this.config = {
        webhookUrl: config.webhookUrl,
        target: config.target || "body",
        mode: config.mode || "window",
        showWelcomeScreen: config.showWelcomeScreen !== false,
        initialMessages: config.initialMessages || [
          "¡Hola! ¿En qué puedo ayudarte?",
        ],
        i18n: config.i18n || {
          en: {
            title: "Chat de Soporte",
            subtitle: "Estamos aquí para ayudarte",
            inputPlaceholder: "Escribe tu mensaje...",
            getStarted: "Iniciar conversación",
          },
        },
      };

      this.isOpen = false;
      this.messages = [];
      this.init();
    }

    init() {
      this.createChatHTML();
      this.bindEvents();
      this.showInitialMessages();
    }

    createChatHTML() {
      const chatHTML = `
        <div id="n8n-chat-widget" class="n8n-chat-widget">
          <div class="chat-toggle" id="chatToggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
          </div>
          
          <div class="chat-window" id="chatWindow">
            <div class="chat-header">
              <h3>${this.config.i18n.en.title}</h3>
              <button class="chat-close" id="chatClose">×</button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
              <!-- Los mensajes se insertan aquí dinámicamente -->
            </div>
            
            <div class="chat-input-container">
              <input type="text" id="chatInput" placeholder="${this.config.i18n.en.inputPlaceholder}">
              <button id="chatSend">Enviar</button>
            </div>
          </div>
        </div>
      `;

      // Insertar el HTML en el target especificado
      const targetElement = document.querySelector(this.config.target);
      targetElement.insertAdjacentHTML("beforeend", chatHTML);

      // Agregar estilos CSS
      this.addStyles();
    }

    addStyles() {
      const styles = `
        <style>
          .n8n-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          }
  
          .chat-toggle {
            width: 60px;
            height: 60px;
            background: rgba(255, 107, 157);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            transition: all 0.3s ease;
          }
  
          .chat-toggle:hover {
            background: #ff8d8d;
            transform: translateY(-2px);
            box-shadow: 0 15px 18px rgba(255, 141, 141, 0.25);
          }
  
          .chat-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 75vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: none;
            flex-direction: column;
            overflow: hidden;
          }

          @media screen and (max-width: 390px) {
            .chat-window {
              width: 250px;
            }
          }
  
          .chat-window.active {
            display: flex;
          }
  
          .chat-header {
            background: rgba(255, 107, 157);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
  
          .chat-header h3 {
            margin: 0;
            font-size: 1rem;
          }
  
          .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
          }
  
          .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
          }
  
          .message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 12px;
            word-wrap: break-word;
          }
  
          .message.bot {
            background: #f1f3f4;
            align-self: flex-start;
          }
  
          .message.user {
            background: rgba(255, 107, 157, 0.5);
            color: white;
            align-self: flex-end;
            font-weight: bold;
          }
  
          .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
          }
  
          .chat-input-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
          }
  
          .chat-input-container button {
            padding: 0.75rem 1rem;
            background: rgba(255, 115, 157);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
          }

          @media (max-width: 390px) {
            .chat-input-container input {
              width: 65%;
              height: auto;
            }
          }
        </style>
      `;

      document.head.insertAdjacentHTML("beforeend", styles);
    }

    bindEvents() {
      const toggle = document.getElementById("chatToggle");
      const close = document.getElementById("chatClose");
      const send = document.getElementById("chatSend");
      const input = document.getElementById("chatInput");

      toggle.addEventListener("click", () => this.toggleChat());
      close.addEventListener("click", () => this.closeChat());
      send.addEventListener("click", () => this.sendMessage());
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") this.sendMessage();
      });
    }

    toggleChat() {
      const window = document.getElementById("chatWindow");
      this.isOpen = !this.isOpen;
      window.classList.toggle("active", this.isOpen);
    }

    closeChat() {
      const window = document.getElementById("chatWindow");
      this.isOpen = false;
      window.classList.remove("active");
    }

    showInitialMessages() {
      this.config.initialMessages.forEach((message) => {
        this.addMessage(message, "bot");
      });
    }

    sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();

      if (!message) return;

      // Agregar mensaje del usuario
      this.addMessage(message, "user");
      input.value = "";

      // Enviar al webhook de n8n
      this.sendToWebhook(message);
    }

    addMessage(content, sender) {
      const messagesContainer = document.getElementById("chatMessages");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = content;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async sendToWebhook(message) {
      try {
        const response = await fetch(this.config.webhookUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chatInput: message,
            sessionId: this.getSessionId(),
          }),
        });

        const data = await response.json();

        // Agregar respuesta del bot
        if (data.output) {
          this.addMessage(data.output, "bot");
        }
      } catch (error) {
        console.error("Error sending message:", error);
        this.addMessage("Lo siento, hubo un error. Intenta de nuevo.", "bot");
      }
    }

    getSessionId() {
      let sessionId = localStorage.getItem("chat-session-id");
      if (!sessionId) {
        sessionId =
          "session-" +
          Date.now() +
          "-" +
          Math.random().toString(36).substr(2, 9);
        localStorage.setItem("chat-session-id", sessionId);
      }
      return sessionId;
    }
  }

  // Función global para crear el chat
  function createChat(config) {
    return new ChatWidget(config);
  }

  // ...eliminado export CommonJS, solo global...

  // Hacer disponible globalmente
  window.createChat = createChat;
</script>
<script is:inline>
  window.addEventListener("DOMContentLoaded", function () {
    if (window.createChat) {
      window.createChat({
        webhookUrl:
          "https://n8n.srv966063.hstgr.cloud/webhook/ea9a7e4b-95ee-47d8-a238-793559e5eaae/chat",
      });
    }
  });
</script>
